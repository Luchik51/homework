# 07. Ansible cruise

## Install Nginx

If Apache web server is work -> stop the service apache.

```bash
ansible-playbook -i inventory.yaml nginx.yaml -u root

PLAY [all_workers] *************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:04 +0300 (0:00:00.013)       0:00:00.013 ****** 
ok: [host20]
ok: [host19]

TASK [nginx : Include deploy for Debian systems] *******************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:06 +0300 (0:00:02.309)       0:00:02.322 ****** 
skipping: [host19]
included: /home/luchik/Yandex.Disk/it-academy/Git/Homework/07.Ansible.Cruise/roles/nginx/tasks/http_deb.yaml for host20

TASK [nginx : Apache2. Install packages] ***************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:06 +0300 (0:00:00.089)       0:00:02.412 ****** 
ok: [host20]

TASK [nginx : Apache2. Disable and stop service] *******************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:11 +0300 (0:00:04.317)       0:00:06.729 ****** 
ok: [host20]

TASK [nginx : Nginx. Enable and start service] *********************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:12 +0300 (0:00:01.199)       0:00:07.929 ****** 
ok: [host20]

TASK [nginx : Include deploy for RedHat systems] *******************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:13 +0300 (0:00:00.817)       0:00:08.747 ****** 
skipping: [host20]
included: /home/luchik/Yandex.Disk/it-academy/Git/Homework/07.Ansible.Cruise/roles/nginx/tasks/http_rh.yaml for host19

TASK [nginx : Nginx. Install packages] *****************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:13 +0300 (0:00:00.102)       0:00:08.850 ****** 
ok: [host19]

TASK [nginx : Nginx. Enable and start service] *********************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:14 +0300 (0:00:01.612)       0:00:10.462 ****** 
ok: [host19]

TASK [nginx : Ngixn. Enable firewall port] *************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:15 +0300 (0:00:00.871)       0:00:11.334 ****** 
ok: [host19] => (item=80/tcp)
ok: [host19] => (item=443/tcp)

TASK [nginx : Copy first page Debian] ******************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:17 +0300 (0:00:02.040)       0:00:13.375 ****** 
ok: [host20]
changed: [host19]

TASK [nginx : Copy first page Centos] ******************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:19 +0300 (0:00:01.916)       0:00:15.291 ****** 
ok: [host20]
changed: [host19]

TASK [nginx : Check connection to Localhost] ***********************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:21 +0300 (0:00:01.853)       0:00:17.145 ****** 
ok: [host20]
ok: [host19]

TASK [nginx : print out] *******************************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:22 +0300 (0:00:00.746)       0:00:17.892 ****** 
ok: [host19] => {
    "msg": {
        "changed": false,
        "elapsed": 0,
        "failed": false,
        "match_groupdict": {},
        "match_groups": [],
        "path": null,
        "port": 80,
        "search_regex": null,
        "state": "started"
    }
}
ok: [host20] => {
    "msg": {
        "changed": false,
        "elapsed": 0,
        "failed": false,
        "match_groupdict": {},
        "match_groups": [],
        "path": null,
        "port": 80,
        "search_regex": null,
        "state": "started"
    }
}

TASK [nginx : Templates] *******************************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:22 +0300 (0:00:00.061)       0:00:17.953 ****** 
ok: [host20]
ok: [host19]

TASK [nginx : Check content to the sites] **************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:23 +0300 (0:00:01.195)       0:00:19.149 ****** 
ok: [host20] => (item={'name': 'local-cent.site', 'ip': '192.168.202.19'})
ok: [host19] => (item={'name': 'local-cent.site', 'ip': '192.168.202.19'})
ok: [host20] => (item={'name': 'local-deb.site', 'ip': '192.168.202.20'})
ok: [host19] => (item={'name': 'local-deb.site', 'ip': '192.168.202.20'})

TASK [nginx : print out] *******************************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:25 +0300 (0:00:01.633)       0:00:20.783 ****** 
ok: [host19] => {
    "msg": {
        "changed": false,
        "msg": "All items completed",
        "results": [
            {
                "accept_ranges": "bytes",
                "ansible_loop_var": "item",
                "changed": false,
                "connection": "close",
                "content": "<h1>Hi from Nginx $(uname -r)</h1>\n",
                "content_length": "35",
                "content_type": "text/html",
                "cookies": {},
                "cookies_string": "",
                "date": "Thu, 08 Sep 2022 11:32:24 GMT",
                "elapsed": 0,
                "etag": "\"6319d2c4-23\"",
                "failed": false,
                "failed_when_result": false,
                "invocation": {
                    "module_args": {
                        "attributes": null,
                        "body": null,
                        "body_format": "raw",
                        "ca_path": null,
                        "client_cert": null,
                        "client_key": null,
                        "creates": null,
                        "dest": null,
                        "follow_redirects": "safe",
                        "force": false,
                        "force_basic_auth": false,
                        "group": null,
                        "headers": {},
                        "http_agent": "ansible-httpget",
                        "method": "GET",
                        "mode": null,
                        "owner": null,
                        "remote_src": false,
                        "removes": null,
                        "return_content": true,
                        "selevel": null,
                        "serole": null,
                        "setype": null,
                        "seuser": null,
                        "src": null,
                        "status_code": [
                            200
                        ],
                        "timeout": 30,
                        "unix_socket": null,
                        "unredirected_headers": [],
                        "unsafe_writes": false,
                        "url": "http://local-cent.site",
                        "url_password": null,
                        "url_username": null,
                        "use_gssapi": false,
                        "use_proxy": true,
                        "validate_certs": true
                    }
                },
                "item": {
                    "ip": "192.168.202.19",
                    "name": "local-cent.site"
                },
                "last_modified": "Thu, 08 Sep 2022 11:32:20 GMT",
                "msg": "OK (35 bytes)",
                "redirected": false,
                "server": "nginx/1.14.1",
                "status": 200,
                "url": "http://local-cent.site"
            },
            {
                "accept_ranges": "bytes",
                "ansible_loop_var": "item",
                "changed": false,
                "connection": "close",
                "content": "<h1>Hi from Nginx $(uname -r)</h1>\n",
                "content_length": "35",
                "content_type": "text/html",
                "cookies": {},
                "cookies_string": "",
                "date": "Thu, 08 Sep 2022 11:32:25 GMT",
                "elapsed": 0,
                "etag": "\"63179731-23\"",
                "failed": false,
                "failed_when_result": false,
                "invocation": {
                    "module_args": {
                        "attributes": null,
                        "body": null,
                        "body_format": "raw",
                        "ca_path": null,
                        "client_cert": null,
                        "client_key": null,
                        "creates": null,
                        "dest": null,
                        "follow_redirects": "safe",
                        "force": false,
                        "force_basic_auth": false,
                        "group": null,
                        "headers": {},
                        "http_agent": "ansible-httpget",
                        "method": "GET",
                        "mode": null,
                        "owner": null,
                        "remote_src": false,
                        "removes": null,
                        "return_content": true,
                        "selevel": null,
                        "serole": null,
                        "setype": null,
                        "seuser": null,
                        "src": null,
                        "status_code": [
                            200
                        ],
                        "timeout": 30,
                        "unix_socket": null,
                        "unredirected_headers": [],
                        "unsafe_writes": false,
                        "url": "http://local-deb.site",
                        "url_password": null,
                        "url_username": null,
                        "use_gssapi": false,
                        "use_proxy": true,
                        "validate_certs": true
                    }
                },
                "item": {
                    "ip": "192.168.202.20",
                    "name": "local-deb.site"
                },
                "last_modified": "Tue, 06 Sep 2022 18:53:37 GMT",
                "msg": "OK (35 bytes)",
                "redirected": false,
                "server": "nginx/1.18.0 (Ubuntu)",
                "status": 200,
                "url": "http://local-deb.site"
            }
        ],
        "skipped": false
    }
}
ok: [host20] => {
    "msg": {
        "changed": false,
        "msg": "All items completed",
        "results": [
            {
                "accept_ranges": "bytes",
                "ansible_loop_var": "item",
                "changed": false,
                "connection": "close",
                "content": "<h1>Hi from Nginx $(uname -r)</h1>\n",
                "content_length": "35",
                "content_type": "text/html",
                "cookies": {},
                "cookies_string": "",
                "date": "Thu, 08 Sep 2022 11:32:24 GMT",
                "elapsed": 0,
                "etag": "\"6319d2c4-23\"",
                "failed": false,
                "failed_when_result": false,
                "invocation": {
                    "module_args": {
                        "attributes": null,
                        "body": null,
                        "body_format": "raw",
                        "ca_path": null,
                        "client_cert": null,
                        "client_key": null,
                        "creates": null,
                        "dest": null,
                        "follow_redirects": "safe",
                        "force": false,
                        "force_basic_auth": false,
                        "group": null,
                        "headers": {},
                        "http_agent": "ansible-httpget",
                        "method": "GET",
                        "mode": null,
                        "owner": null,
                        "remote_src": false,
                        "removes": null,
                        "return_content": true,
                        "selevel": null,
                        "serole": null,
                        "setype": null,
                        "seuser": null,
                        "src": null,
                        "status_code": [
                            200
                        ],
                        "timeout": 30,
                        "unix_socket": null,
                        "unredirected_headers": [],
                        "unsafe_writes": false,
                        "url": "http://local-cent.site",
                        "url_password": null,
                        "url_username": null,
                        "use_gssapi": false,
                        "use_proxy": true,
                        "validate_certs": true
                    }
                },
                "item": {
                    "ip": "192.168.202.19",
                    "name": "local-cent.site"
                },
                "last_modified": "Thu, 08 Sep 2022 11:32:20 GMT",
                "msg": "OK (35 bytes)",
                "redirected": false,
                "server": "nginx/1.14.1",
                "status": 200,
                "url": "http://local-cent.site"
            },
            {
                "accept_ranges": "bytes",
                "ansible_loop_var": "item",
                "changed": false,
                "connection": "close",
                "content": "<h1>Hi from Nginx $(uname -r)</h1>\n",
                "content_length": "35",
                "content_type": "text/html",
                "cookies": {},
                "cookies_string": "",
                "date": "Thu, 08 Sep 2022 11:32:25 GMT",
                "elapsed": 0,
                "etag": "\"63179731-23\"",
                "failed": false,
                "failed_when_result": false,
                "invocation": {
                    "module_args": {
                        "attributes": null,
                        "body": null,
                        "body_format": "raw",
                        "ca_path": null,
                        "client_cert": null,
                        "client_key": null,
                        "creates": null,
                        "dest": null,
                        "follow_redirects": "safe",
                        "force": false,
                        "force_basic_auth": false,
                        "group": null,
                        "headers": {},
                        "http_agent": "ansible-httpget",
                        "method": "GET",
                        "mode": null,
                        "owner": null,
                        "remote_src": false,
                        "removes": null,
                        "return_content": true,
                        "selevel": null,
                        "serole": null,
                        "setype": null,
                        "seuser": null,
                        "src": null,
                        "status_code": [
                            200
                        ],
                        "timeout": 30,
                        "unix_socket": null,
                        "unredirected_headers": [],
                        "unsafe_writes": false,
                        "url": "http://local-deb.site",
                        "url_password": null,
                        "url_username": null,
                        "use_gssapi": false,
                        "use_proxy": true,
                        "validate_certs": true
                    }
                },
                "item": {
                    "ip": "192.168.202.20",
                    "name": "local-deb.site"
                },
                "last_modified": "Tue, 06 Sep 2022 18:53:37 GMT",
                "msg": "OK (35 bytes)",
                "redirected": false,
                "server": "nginx/1.18.0 (Ubuntu)",
                "status": 200,
                "url": "http://local-deb.site"
            }
        ],
        "skipped": false
    }
}

RUNNING HANDLER [nginx : restart nginx] ****************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:25 +0300 (0:00:00.134)       0:00:20.918 ****** 
changed: [host19]

RUNNING HANDLER [nginx : stop apache] ******************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:32:26 +0300 (0:00:00.996)       0:00:21.914 ****** 
fatal: [host19]: FAILED! => {"changed": false, "msg": "value of state must be one of: reloaded, restarted, started, stopped, got: stop"}

NO MORE HOSTS LEFT *************************************************************************************************************************************************************************************************************************

PLAY RECAP *********************************************************************************************************************************************************************************************************************************
host19                     : ok=13   changed=3    unreachable=0    failed=1    skipped=1    rescued=0    ignored=0   
host20                     : ok=12   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

Четверг 08 сентября 2022  14:32:27 +0300 (0:00:00.863)       0:00:22.778 ****** 
=============================================================================== 
nginx : Apache2. Install packages --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 4.32s
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 2.31s
nginx : Ngixn. Enable firewall port ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 2.04s
nginx : Copy first page Debian ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1.92s
nginx : Copy first page Centos ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 1.85s
nginx : Check content to the sites -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.63s
nginx : Nginx. Install packages ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.61s
nginx : Apache2. Disable and stop service ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.20s
nginx : Templates ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.20s
nginx : restart nginx --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.00s
nginx : Nginx. Enable and start service --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.87s
nginx : stop apache ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.86s
nginx : Nginx. Enable and start service --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.82s
nginx : Check connection to Localhost ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.75s
nginx : print out ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.13s
nginx : Include deploy for RedHat systems ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.10s
nginx : Include deploy for Debian systems ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.09s
nginx : print out ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.06s
Playbook run took 0 days, 0 hours, 0 minutes, 22 seconds
```

## Testing role
```bash
ansible-playbook -i inventory.yaml test.yaml -u root

PLAY [all_workers] *************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:29:59 +0300 (0:00:00.028)       0:00:00.028 ****** 
ok: [host19]
ok: [host20]

TASK [tests : run command] *****************************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:30:03 +0300 (0:00:03.180)       0:00:03.209 ****** 
changed: [host20]
changed: [host19]

TASK [tests : Check connections to public repositories] ************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:30:03 +0300 (0:00:00.754)       0:00:03.963 ****** 
ok: [host20] => (item=https://deb.debian.org/debian)
ok: [host19] => (item=https://deb.debian.org/debian)
ok: [host20] => (item=https://cloud.centos.org/centos)
ok: [host19] => (item=https://cloud.centos.org/centos)
ok: [host20] => (item=https://pypi.org/simple)
ok: [host19] => (item=https://pypi.org/simple)

TASK [tests : Check if we have connection to docker hub registry] **************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:30:17 +0300 (0:00:13.752)       0:00:17.715 ****** 
ok: [host20]
ok: [host19]

TASK [tests : Check if we have enough RAM] *************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:30:18 +0300 (0:00:01.315)       0:00:19.031 ****** 
ok: [host19] => {
    "msg": "Total RAM is 2048MB. Free RAM > 800MB"
}
ok: [host20] => {
    "msg": "Total RAM is 2048MB. Free RAM > 800MB"
}

TASK [tests : Check if we have enough HDD] *************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:30:19 +0300 (0:00:00.080)       0:00:19.111 ****** 
ok: [host19] => {
    "msg": "Total space on HDD 18049.046875MB. Free  space > 1Gb"
}
ok: [host20] => {
    "msg": "Total space on HDD 17664.0078125MB. Free  space > 1Gb"
}

TASK [tests : Check we have RAM] ***********************************************************************************************************************************************************************************************************
Четверг 08 сентября 2022  14:30:19 +0300 (0:00:00.115)       0:00:19.227 ****** 
ok: [host19] => {
    "msg": "total RAM is 2048"
}
ok: [host20] => {
    "msg": "total RAM is 2048"
}

PLAY RECAP *********************************************************************************************************************************************************************************************************************************
host19                     : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
host20                     : ok=7    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

Четверг 08 сентября 2022  14:30:19 +0300 (0:00:00.100)       0:00:19.328 ****** 
=============================================================================== 
tests : Check connections to public repositories ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 13.75s
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 3.18s
tests : Check if we have connection to docker hub registry -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.32s
tests : run command ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.75s
tests : Check if we have enough HDD ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.12s
tests : Check we have RAM ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.10s
tests : Check if we have enough RAM ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.08s
Playbook run took 0 days, 0 hours, 0 minutes, 19 seconds
 ```
